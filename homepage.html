<!DOCTYPE html>
<html>
        <head>
                <title>homepage</title>
                <link rel="stylesheet" type="text/css" href="elements.css?v=123">
        </head>
        <body>
		<div class="top-panel">
		<h1 class="centered">Lamazon</h1>

		<form id="search-bar" class="form centered">
			<div class="form-group1">
				<input type="text" placeholder="Search products" id="searched-product">
			</div>

			<input type="submit" class="button" id="search-button" value="Search Lamazon">
		</form>

		<div id="cart-button-top">
			<a class="link2button" href="http://localhost:5500/visitcart.html">Cart</a>
		</div>


		</div>
		
		<div class="not-top-panel">
			<div id="nav-bar">
				<ul>
					<li><a href="aboutme.html">about me</a></li>
					<li><a href="admin.html">admin</a></li>
				</ul>
			</div>

			<div id="productDiv">
				<div id="product-image"></div>
			<h2 id='output'></h2>
			</div>

		</div>
	</body>
	<script>

		const token = localStorage.getItem("access_token");
		window.onload = function displayProducts() {
			fetch('http://127.0.0.1:8000/displayproducts/', {
			method:'GET',
			headers: {
				"Authorization": `Bearer ${token}`
			}
		})

		.then(res => {
			return res.json().then(data => ({ status: res.status, data: data }));
		})
		.then(({ status, data }) => {
			if (status === 200) {
				data.forEach(function(product) {
					const productDivHome = document.getElementById('productDiv');
					productDivHome.setAttribute("class", "product");
					output.insertAdjacentHTML("beforeend", `
						<div id="${product.name}-border">
							<ul>
								<li>${product.name}</li>
								<li>Price: ${product.price/100}$</li>
							</ul>
							<button id="${product.name}-button" class="buttonCart">Add to cart</button>
							<h3 id="${product.name}-output"></h3>
						</div>

					`);

					div = document.getElementById(`${product.name}-border`);
					div.setAttribute("class", "border");
					const btn = document.getElementById(`${product.name}-button`)
					btn.addEventListener('click', function AddToCart(e){
						e.preventDefault();
						const product1 = product.name;
						fetch('http://127.0.0.1:8000/addtocart/', { 
							method: 'POST',
							headers: {
								"Authorization": `Bearer ${token}`,
								"Accept": 'application/json, text/plain, */*',
								"Content-type": 'application/json'
							},
							body:JSON.stringify({product_name:product1})
						})
						.then(res => {
							return res.json().then(data => ({ status: res.status, data: data }));
						})
						.then(({ status, data }) => {
							if (status === 200) {
								console.log(data)
								const cartOutput = document.getElementById(`${product.name}-output`);
								cartOutput.classList.add('output');
								cartOutput.innerHTML = data.message;
								setTimeout(() => cartOutput.remove(), 3000);
								localStorage.setItem("cart_id", data.cart_id);
							} else {
								window.location.reload()
								output.innerHTML = data.detail;
								setTimeout(() => output.remove(), 5000);

							}
						});


					
					})
			})
		};
		})
		document.getElementById('search-button').addEventListener('click', searchProduct);
		
		function searchProduct(e){
			e.preventDefault()
			const product = document.getElementById('searched-product').value;	
			const output = document.getElementById('output');
			fetch(`http://127.0.0.1:8000/searchproducts/${product}`, {
				method: 'GET',
				headers: {
					"Authorization": `Bearer ${token}`
				}
			})
			.then(res => {
                                return res.json().then(data => ({ status: res.status, data: data }));
                        })
                        .then(({ status, data }) => {
                                if (status === 200) {
					const productDiv = document.getElementById('productDiv');
					productDiv.classList.add('product');
					output.innerHTML = `
						<div id="border">
							<ul>
								<li>${data.name}</li>
								<li>Price: ${data.price/100}$</li>
							</ul>
							<button id="cart-button" class="buttonCart">Add to cart</button>
							<h3 id="cart-output"></h3>
						</div>
					`;

					const div = document.getElementById('border');
					div.setAttribute('class', 'border');
							
					document.getElementById('cart-button').addEventListener('click', AddToCart);

					function AddToCart(e){
						e.preventDefault();
						const product = document.getElementById('searched-product').value;	
						fetch('http://127.0.0.1:8000/addtocart/', { 
							method: 'POST',
							headers: {
								"Authorization": `Bearer ${token}`,
								"Accept": 'application/json, text/plain, */*',
								"Content-type": 'application/json'
							},
							body:JSON.stringify({product_name:product})
						})
						.then(res => {
							return res.json().then(data => ({ status: res.status, data: data }));
						})
						.then(({ status, data }) => {
							if (status === 200) {
								console.log(data)
								const output = document.getElementById('cart-output');
								output.classList.add('output');
								output.innerHTML = data.message;
								setTimeout(() => output.remove(), 3000);
								localStorage.setItem("cart_id", data.cart_id);
							} else {
								window.location.reload()
								output.innerHTML = data.detail;
								setTimeout(() => output.remove(), 5000);

							}
						});
					};

					document.getElementById('checkout-button').addEventListener('click', checkout);

					function checkout(e){
						e.preventDefault();
						window.location.assign('http://localhost:5500/checkout.html');
					};
				} else {
 					window.location.reload()
					output.innerHTML = data.detail;
                                        setTimeout(() => output.remove(), 5000);

				}
			});
		}

		}

	</script>
</html>

