<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="elements.css?v=123">
	</head>
	<body>
		<div class="container">
			<h1 class="text">Your cart</h1>
			<h2 id="output1"></h2>
			<button id="submitCart" class="link2button">Checkout</button>
		</div>
	</body>
	<script>
		const output = document.getElementById('output1');
		const button = document.getElementById('submitCart');
		const token = localStorage.getItem('access_token');
		
		window.onload = function cartItems() {
			const cartId = localStorage.getItem('cart_id');

			fetch(`http://127.0.0.1:8000/viewcart/${cartId}`, {
				method: 'GET',
				headers: {
					"Authorization": `Bearer ${token}`,
					"Accept": 'application/json, text/plain, */*',
					"Content-type": 'application/json'
				}

			})
			.then(res => {
				return res.json().then(data => ({ status: res.status, data: data }));
			})
			.then(({ status, data }) => {
				if (status === 200) {
					const items = data.cart_products;
					items.forEach(function(item) {
						output.classList.add('text');
						output.insertAdjacentHTML('beforeend', `
							<ul id="item">
								<li>${item.name}, price:${item.price / 100}$</li>
							</ul>

							<form id="${item.name}-form">
								<label for="${item.name}quantity">Quantity: </label>
								<input type="number" id="${item.name}quantity">
							</form>
							<button id="remove${item.name}" class="link2button">Remove from cart</button>
						`);

						
						const removeBtn = document.getElementById(`remove${item.name}`);
						removeBtn.addEventListener('click', function removeItem(e) {
							e.preventDefault();
							fetch('http://127.0.0.1:8000/removeproductfromcart/', {
								method: 'PUT',
								headers: {
									"Authorization": `Bearer ${token}`,
									"Accept": 'application/json, text/plain, */*',
									"Content-type": 'application/json'
								},
								body:JSON.stringify({product_name:item.name})

							})
							.then(res => {
							return res.json().then(data => ({ status: res.status, data: data }));
							})
							.then(({ status, data }) => {
							if (status === 200) {
								window.reload();
							}


							})

						});
							

						const button = document.getElementById('submitCart');
						button.addEventListener("click", () => {

							items.forEach((item) => {

								const quantity1 = document.getElementById(`${item.name}quantity`).value;
								item.quantity = parseInt(quantity1);	

							});
						fetch('http://127.0.0.1:8000/create_checkout_session', {
						method: 'POST',
						headers: {
							"Authorization": `Bearer ${token}`,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(items)
						})
						.then((res) => {
							if (res.ok) return res.json()
							return res.json().then(json => Promise.reject(json))
						})
						.then(({ url }) => {
							window.location = url;
						})
						.catch((e) => {
							console.error(e)
						})

					});

					})
						

					};
				})




              

		}
	</script>
</html>

